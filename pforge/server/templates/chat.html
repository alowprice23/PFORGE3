{% extends "base.html" %}

{% block title %}pForge Chat{% endblock %}

{% block head %}
    <style>
        #chat-log {
            height: 60vh;
        }
        .chat-bubble {
            max-width: 75%;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .user-bubble {
            background-color: #3B82F6; /* blue-500 */
            color: white;
            align-self: flex-end;
        }
        .agent-bubble {
            background-color: #E5E7EB; /* gray-200 */
            color: #1F2937; /* gray-800 */
            align-self: flex-start;
        }
    </style>
{% endblock %}

{% block content %}
<div class="flex flex-col h-full">
    <div id="chat-log" class="overflow-y-auto p-4 border rounded-lg bg-white flex flex-col space-y-2">
        <!-- Chat messages will be appended here -->
        <div class="chat-bubble agent-bubble">
            Hello! I am pForge. How can I help you debug today?
        </div>
    </div>
    <form id="chat-form" class="mt-4 flex">
        <input id="message-input" type="text" class="flex-grow p-2 border rounded-l-lg" placeholder="Type your message here..." autocomplete="off">
        <button type="submit" class="bg-gray-800 text-white px-4 py-2 rounded-r-lg hover:bg-gray-700">Send</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        const chatLog = document.getElementById('chat-log');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');

        function addMessage(message, sender) {
            const bubble = document.createElement('div');
            bubble.classList.add('chat-bubble');
            bubble.classList.add(sender === 'user' ? 'user-bubble' : 'agent-bubble');
            bubble.textContent = message;
            chatLog.appendChild(bubble);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // Use the SSE stream for receiving messages
        const eventSource = new EventSource("/chat/events");
        eventSource.addEventListener("chat:outgoing", function(event) {
            const data = JSON.parse(event.data);
            addMessage(data.msg, 'agent');
        });

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            messageInput.value = '';

            await fetch('/chat/nl', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ msg: message })
            });
        });
    });
</script>
{% endblock %}
