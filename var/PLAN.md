# PLAN: `var/` Directory

## 1. Directory Purpose & Scope

**Purpose**: To provide a standard, ephemeral, and non-version-controlled location for all runtime-generated artifacts of the pForge system. This directory holds the "working state" and "scratchpad" of the applicationâ€”data that is necessary for its operation but is not part of its core source code. Its contents are considered transient and should be safely ignorable and fully rebuildable.

**Scope of Ownership**:

*   **Runtime Indices (`index/`)**: It provides the storage location for expensive-to-compute indices that are cached for performance, such as the dependency graph and coverage map.
*   **Logs (`logs/`)**: It is the designated location for all runtime logs, including the detailed AMP event stream and metric snapshots, which are used for debugging and post-hoc analysis.
*   **Databases (`db/`)**: It owns the physical storage location for all SQLite databases, which contain the system's persistent state, such as the agentic CLI's memory and security nonces.

**Explicitly Not in Scope**:

*   **Source Code**: This directory must **never** contain version-controlled source code. It is explicitly listed in the `.gitignore` file.
*   **Configuration**: All configuration files reside in the `config/` directory.
*   **Test Data**: All static test and benchmark data resides in the `data/` directory.
*   **Snapshots**: While the `var` directory *could* house the CAS for snapshots, the plan places it under `pforge/var` to keep it with the source, but it's a runtime artifact. The `FILEMAP.md` has it under `var/`, which is a good convention for ephemeral data.

---

## 2. File-by-File Blueprints

The files and directories within `var/` are not created by the developer but are generated by the pForge application at runtime. The plan here is to describe what *will be* created.

*   **`.gitkeep`**: A conventional empty file to ensure that the `var/` directory itself is checked into version control, so that the application has a known location to write its runtime files to.

*   **`index/` Subdirectory**: This directory will be created by the system to store cached indices.
    *   `coverage.json`: Created by `validation/coverage_index.py`. Contains the JSON representation of the test-to-file coverage map.
    *   `dep_graph.json`: Created by `validation/dep_graph.py`. Contains the JSON representation of the module dependency graph.

*   **`logs/` Subdirectory**: This directory will be created to store logs.
    *   `amp.jsonl`: An append-only log file where a copy of every AMP event can be written in JSON Lines format. This provides a persistent record for debugging and backtesting.
    *   `metrics.jsonl`: A log of metric snapshots, potentially captured periodically for analysis.

*   **`db/` Subdirectory**: This directory will be created to store the SQLite database files.
    *   `constellation.sqlite`: The database file for the agentic CLI's memory, managed by `memory/constellation.py`.
    *   `nonces.sqlite`: The database for storing used capability nonces.
    *   `budget.sqlite`: The database for the persistent token budget ledger.

---

## 3. Math & Guarantees (from README)

This directory provides no mathematical guarantees itself. Instead, it is the physical location where the **data that backs the guarantees** is stored. The integrity of the files in `var/db/` is critical for the long-term learning and security of the system, and the logs in `var/logs/` are the raw data source for any backtesting or verification.

---

## 4. Routing & Awareness

This directory is not involved in routing.

---

## 5. Token & Budget Hygiene

The `db/budget.sqlite` file provides the persistent, auditable ledger of all token spend, making the system's cost transparent and analyzable over the long term.

---

## 6. Operational Flows

*   **First Run Flow**:
    1.  The user starts pForge for the first time.
    2.  The application code checks for the existence of the `var/` subdirectories (`index`, `logs`, `db`).
    3.  Seeing they don't exist, it creates them.
    4.  It initializes the SQLite databases by executing the schemas from `storage/sqlite/`.
    5.  It runs the indexers from `validation/` to generate the initial `coverage.json` and `dep_graph.json`.
*   **Normal Operation Flow**:
    1.  The application starts.
    2.  It connects to the existing SQLite databases in `var/db/`.
    3.  It loads the indices from `var/index/` and checks if they are stale.
    4.  As agents run, they append log entries to the files in `var/logs/`.

---

## 7. Testing & Backtests

*   **Test Isolation**: The test suite must be configured to use a temporary, separate `var/` directory for each test run. This is a critical principle to ensure that tests are hermetic and do not interfere with each other or depend on the state left over from a previous run. This is typically handled in a `pytest` `conftest.py` file by creating and tearing down a temporary directory fixture.

---

## 8. Security & Policy

*   **Data Sensitivity**: The files in this directory, especially the logs and databases, can contain sensitive operational data. In a production or multi-tenant environment, the `var/` directory and its subdirectories should have strict file permissions, ensuring that one user or tenant cannot access the runtime data of another.
*   **Gitignore**: The `var/` directory must be included in the project's `.gitignore` file to prevent transient runtime artifacts from ever being accidentally committed to version control.

---

## 9. Readme Cross-Reference

This directory is the "workbench" or "scratchpad" for the puzzle solver from the `README.md`. It is not the puzzle itself, nor the tools to solve it, but the physical table where the work is done.

| Var Component | README.md Concept Cross-Reference |
| :--- | :--- |
| `index/` | The solver's quick-reference notes and diagrams about how the puzzle pieces are shaped and interconnected. |
| `logs/` | The detailed, move-by-move logbook or "game tape" of the entire puzzle-solving session. |
| `db/` | The solver's long-term memory and notebook, where it records its experiences and learned strategies. |

This directory provides the necessary ephemeral storage space for the system to operate efficiently and to maintain its state and memory between runs.
